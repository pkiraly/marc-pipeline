# marc-pipeline
MARC pipeline for quality assessment preparation. It transforms binary MARC files to MARCXML (with yaz-marcdump), 
then MARCXML to JSON (with Catmandu) and finally to another special JSON. The final JSON contains one record 
per line -- this is the way Apache Spark ingest files. Other differences

* the order of the components is the same in every records (in Librecat output the order of components is varying)
* the `datafield`'s `subfield` component is always an array of object (in Librecat output it is an object if there is only
one subfield)

## prerequisited softwares

* Catmandu (http://librecat.org/)
* yaz-marcdump ([manual](http://www.indexdata.com/yaz/doc/yaz-marcdump.html), 
[usage examples](http://www.j-gorman.com/blog/2012/4/22/yaz-marcdump-simple-but-powerful-marc-batch-tool.html))
* uconv ([manual](https://linux.die.net/man/1/uconv))

Catmandu requires a special installation, the other two tools are available as standard *nix tools.

## processing single files

1. `toUtf.sh` - convert each XML files in a directory to normal UTF-8 file with the `uconv` tool. The MARC to XML converters
do not deal with the decomposed character. This step is needed if the accented charcters in XML remain decomposed 
(such as an a + ¨ instead of ä). See [Unicode normalization](https://en.wikipedia.org/wiki/Unicode_equivalence#Normalization) 
and [Combining and precomposed characters](https://en.wikipedia.org/wiki/Unicode_equivalence#Combining_and_precomposed_characters).
  
1. `one-file-to-json.sh` - convert xml to json with Catmandu
1. `one-json-to-formatted.sh` - change the json format generated by Catmandu with the `formatCatmanduOutput.php` script

## processing multiple files

1. `toXml.sh` - convert binary MARC files in `marc` directory to XML with `yaz-marcdump`, then split 
the files with `splitXml.php`. Each new file contains maximum 10.000 records.
1. `toJson.sh` - convert XML files in `splitted` directory with Catmandu. Moves converted files to `converted` and .json to `json/raw`
1. `jsonToFormatted.sh` - convert .json files in `json/raw` into a more convenient JSON format. Saves the new files into 
`json/formatted` directory, moves the source file into `json/processed`

## running the XML to JSON process with `cron` scheduler

Edit crontab with the 

```
crontab -e
```

command and add the following line:

```
*/1 * * * * cd /to/working/directory && php toJsonLauncher.php >> launch-report.log
```

This script runs the `one-file-to-json.sh` script on each files listed in the `to-json-setlist.txt` file.

## running the JSON formatting process with `cron` scheduler

Edit crontab with the 

```
crontab -e
```

command and add the following line:

```
*/1 * * * * cd /to/working/directory && php toFormattedLauncher.php >> launch-report.log
```

This script runs the `one-json-to-formatted.sh` script on each files listed in the `to-formatted-setlist.txt` file.
