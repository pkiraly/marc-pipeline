# marc-pipeline
MARC pipeline for quality assessment preparation.

## prerequisites

* catmandu (http://librecat.org/)
* yaz-marcdump (http://www.indexdata.com/yaz/doc/yaz-marcdump.html, http://www.j-gorman.com/blog/2012/4/22/yaz-marcdump-simple-but-powerful-marc-batch-tool.html)
* uconv (https://linux.die.net/man/1/uconv)

## processing single files

1. `toUtf.sh` - convert each XML files in a directory to normal UTF-8 file with the `uconv` tool. The MARC to XML converters
do not deal with the decomposed character. This step is needed if the accented charcters in XML remain decomposed 
(such as an a + ¨ instead of ä). See [normalization](https://en.wikipedia.org/wiki/Unicode_equivalence#Normalization)
https://en.wikipedia.org/wiki/Unicode_equivalence#Combining_and_precomposed_characters
  
1. `one-file-to-json.sh` - convert xml to json with Catmandu
1. `one-json-to-formatted.sh` - change the json format generated by Catmandu with the `formatCatmanduOutput.php` script

## processing multiple files

1. `toXml.sh` - convert binary MARC files in `marc` directory to XML with `yaz-marcdump`, then split 
the files with `splitXml.php`. Each new file contains maximum 10.000 records.
1. `toJson.sh` - convert XML files in `splitted` directory with Catmandu. Moves converted files to `converted` and .json to `raw`
1. `jsonToFormatted.sh` - convert .json files in `json/raw` into a more convenient JSON format. Saves the new files into 
`json/formatted` directory, moves the source file into `json/processed`

## running the XML to JSON process with `cron` scheduler

Edit crontab with the 

```
crontab -e
```

command and add the following line:

```
*/1 * * * * cd /to/working/directory && php toJsonLauncher.php >> launch-report.log
```

This script runs the `one-file-to-json.sh` script on each files listed in the `to-json-setlist.txt` file.

## running the JSON formatting process with `cron` scheduler

Edit crontab with the 

```
crontab -e
```

command and add the following line:

```
*/1 * * * * cd /to/working/directory && php toFormattedLauncher.php >> launch-report.log
```

This script runs the `one-json-to-formatted.sh` script on each files listed in the `to-formatted-setlist.txt` file.
